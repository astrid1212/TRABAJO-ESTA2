---
title: "Entregable 3-Astrid Rosales (20196941)"
author: "astrid1"
date: '2022-06-16'
output: html_document
---

```{r}
library(rio)
library(matrixcalc)
library(ggcorrplot)
library(polycor)
library(psych)
library(ggplot2)
library(cfa)
library(lavaan)
library(BBmisc)
```


```{r}
vdem = import("V-Dem-CY-Core-v12.rds")
View(vdem)
```

#1. Variable dependiente - Índice de Democracia Liberal (v2x_libdem)
```{r}
summary(vdem$v2x_libdem)
```
```{r}
str(vdem$v2x_libdem)
```
#2. Variables independientes - Astrid Rosales
#2.1. Censura Gubernamental
#2.1.1. Censura Gubernamental a Medios de Comunicación (v2mecenefm_ord)
```{r}
str(vdem$ v2mecenefm_ord)
summary(vdem$v2mecenefm_ord)
```
#2.1.2. Censura Gubernamental en Internet (v2mecenefi_ord)
```{r}
str(vdem$v2mecenefi_ord)
summary(vdem$v2mecenefi_ord)
```
#2.1.3. Hostigamiento hacia periodistas (v2meharjrn_ord)
```{r}
str(vdem$v2meharjrn_ord)
summary(vdem$v2meharjrn_ord)
```
#3. Variables independientes- Carlos Chavarri
#3.1.Poder Judicila y exclusión social
#3.1.1 Independencia de la Corte Suprema (v2juhcind_ord)
```{r}
str(vdem$v2juhcind_ord)
summary(vdem$v2juhcind_ord)
```
#3.2.2 Independencia de las otras cortes (v2juncind_ord)
```{r}
str(vdem$v2juncind_ord)
summary(vdem$v2juncind_ord)
```
#3.3.3 Acceso a oportunidades de negocios con el Estado a partir de posición socioeconómica (v2peasbecon_ord)
```{r}
str(vdem$v2peasbecon_ord)
summary(vdem$v2peasbecon_ord)
```
#4. Armar la base de apoyo
```{r}
factor_astrid= subset(vdem, select = c(country_name, year, v2x_libdem, v2mecenefm_ord, v2mecenefi_ord, v2meharjrn_ord , v2juhcind_ord, v2juncind_ord, v2peasbecon_ord))
```
```{r}
factor_astrid = factor_astrid[factor_astrid$year==2021, ]
```
```{r}
factor_astrid$country_name = NULL
factor_astrid$year = NULL
factor_astrid$v2x_libdem = NULL
```
#I. Análisis Factorial Exploratorio
#5. Explorar las correlaciones entre las variables
```{r}
corMatrix_a = polycor::hetcor(factor_astrid)$correlations
corMatrix_a
```
#6. Graficar la matriz de correlaciones
```{r}
ggcorrplot(corMatrix_a)
```
#7. Verificar validez del análisis factorial
#7.1. Verificar si variables se pueden factorizar
Overall MSA es mayor a 0.6, por lo que el análisis factorial es factible.
```{r}
psych::KMO(corMatrix_a)
```
#7.2. Descartar una posible matriz de identidad
Sale FALSE (p-value NO es mayor a 0.05), por lo que el análisis factorial es factible.
```{r}
cortest.bartlett(corMatrix_a, n = nrow(factor_astrid))$p.value>0.05
```
#7.3. Descartar una posible matriz singular
Sale FALSE, por lo que el análisis factorial es factible.
```{r}
is.singular.matrix(corMatrix_a)
```
#8. Determinar en cuántos factores se pueden agrupar las variables
```{r}
fa.parallel(factor_astrid, fm = "ML", fa = "fa")
```
#9. Observar las cargas factoriales y ver en qué factores se ubicaría cada variable
```{r}
resfa_a <- fa(factor_astrid, nfactors = 1, cor = "cor", rotate = "varimax", fm = "minres")
print(resfa_a$loadings, cutoff = 0.5)
```
#10. Graficar cómo se agrupan las variables
```{r}
fa.diagram(resfa_a)
```
#11. Evaluar los resultados obtenidos
#11.1. ¿Qué variables aportaron más a los factores?
```{r}
sort(resfa_a$communality)
```
#12. Observar los posibles valores proyectados
#12.1. Para grabar en la base los puntajes de los factores
```{r}
factor_astrid$puntaje = resfa_a$scores
```
#II. Analisi factorial confirmatorio

#13. Construir modelo lineal
```{r}
modeloa <- ' factor_a  =~ v2mecenefm_ord+v2mecenefi_ord+v2meharjrn_ord+v2juhcind_ord+v2juncind_ord+v2peasbecon_ord'
```

#14. Crear un objeto para hacer las validaciones 

```{r}
cfa_fit <- cfa(modeloa, data= factor_astrid, 
           std.lv=TRUE,  
           missing="fiml")
```

#15. Preparar los test para las validaciones
```{r}
allParamCFA=parameterEstimates(cfa_fit,standardized = T)
allFitCFA=as.list(fitMeasures(cfa_fit))
```

#16. Ver si cada variable tiene buena relacion con su factor (p.value< 0.5 indica que la variable observable tiene buena relacion con sus latente)
```{r}
allParamCFA[allParamCFA$op=="=~",]
```

#17. Ver si la asignacion de variables ha sido relativamente buena, el p.value debe ser mayor a 0.05 para que se bueno
```{r}
allFitCFA[c("chisq", "df", "pvalue")]
```
#18.El Índice Tucker Lewi es mayor a 0.9? Es menor.
```{r}
allFitCFA$tli
```
#19.La Raíz del error cuadrático medio de aproximación es menor a 0.05? No, es mayor
```{r}
allFitCFA[c('rmsea.ci.lower','rmsea' ,'rmsea.ci.upper')]
```
#
```{r}
scorescfa=normalize(lavPredict(cfa_fit),
                    method = "range", 
                    margin=2, # by column
                    range = c(0, 10))
```

```{r}
factor_astrid$prediccion = scorescfa
```
#Veamos ambos scores calculados
```{r}
ggplot(data=factor_astrid,aes(x=prediccion,y=puntaje)) + geom_point() + theme_minimal()
```






























